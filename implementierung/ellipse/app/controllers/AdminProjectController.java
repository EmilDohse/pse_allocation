// --------------------------------------------------------
// Code generated by Papyrus Java
// --------------------------------------------------------

package controllers;

import java.util.ArrayList;

import com.google.inject.Inject;

import data.Adviser;
import data.ElipseModel;
import data.GeneralData;
import data.Project;
import data.Semester;
import form.Forms;
import form.IntValidator;
import form.StringValidator;
import form.ValidationException;
import play.data.DynamicForm;
import play.data.FormFactory;
import play.mvc.Controller;
import play.mvc.Result;

/************************************************************/
/**
 * Dieser Controller ist für das Bearbeiten der Http-Requests zuständig, welche
 * beim Hinzufügen, Ändern und Löschen eines Projektes im Administratorbereich
 * abgeschickt werden.
 */
public class AdminProjectController extends Controller {

    private static final String INTERNAL_ERROR = "error.internalError";

    @Inject
    FormFactory                 formFactory;

    /**
     * Diese Methode fügt ein neues Projekt in das System ein und leitet den
     * Administrator zurück auf die Seite zum Editieren des Projektes.
     * 
     * @return Die Seite, die als Antwort verschickt wird.
     */
    public Result addProject() {
        DynamicForm form = formFactory.form().bindFromRequest();
        if (form.data().isEmpty()) {
            return badRequest(ctx().messages().at(INTERNAL_ERROR));
        }
        String projName = form.get("name");
        int projID = -1;
        Project project = new Project(projName, "", "", "");
        project.save();
        Semester semester = GeneralData.loadInstance().getCurrentSemester();
        semester.doTransaction(() -> {
            semester.addProject(project);
        });
        projID = project.getId();
        return redirect(controllers.routes.AdminPageController.projectEditPage(projID));

    }

    /**
     * Diese Methode löscht ein Projekt und alle dazugehörenden Daten aus dem
     * System und leitet den Administrator weiter auf die Seite zum Editieren
     * und Hinzufügen von Projekten.
     * 
     * @return Die Seite, die als Antwort verschickt wird.
     */
    public Result removeProject() {
        DynamicForm form = formFactory.form().bindFromRequest();
        if (form.data().isEmpty()) {
            return badRequest(ctx().messages().at(INTERNAL_ERROR));
        }
        Project project = ElipseModel.getById(Project.class, Integer.parseInt(form.get("id")));
        // TODO hier eine warnmeldung ausgeben ob das projekt wirklich gelöscht
        // werden soll
        project.delete();

        return redirect(controllers.routes.AdminPageController.projectPage());
    }

    /**
     * Diese Methode editiert ein bereits vorhandenes Projekt. Die zu
     * editierenden Daten übermittelt der Administrator über ein Formular,
     * welches er zum Editieren abschickt. Anschließend wird der Administrator
     * auf die Seite zum Hinzufügen und Editieren von Projekten weitergeleitet.
     * 
     * @return Die Seite, die als Antwort verschickt wird.
     */
    public Result editProject() {
        // die projektdaten werden aus dem formular ausgelesen
        DynamicForm form = formFactory.form().bindFromRequest();
        if (form.data().isEmpty()) {
            return badRequest(ctx().messages().at(INTERNAL_ERROR));
        }
        StringValidator notEmptyValidator = Forms.getNonEmptyStringValidator();
        IntValidator minValidator = new IntValidator(0);

        String projName;
        String url;
        String institute;
        String description;
        String numberOfTeamsString;
        String minSizeString;
        String maxSizeString;
        String idString;
        int numberOfTeams;
        int minSize;
        int maxSize;

        int id;
        try {
            id = minValidator.validate(form.get("idString"));
        } catch (ValidationException e) {
            flash("error", ctx().messages().at(e.getMessage()));
            return redirect(controllers.routes.AdminPageController.projectEditPage(-1));
        }
        Project project = ElipseModel.getById(Project.class, id);
        try {
            projName = notEmptyValidator.validate(form.get("name"));
            url = notEmptyValidator.validate(form.get("url"));
            institute = notEmptyValidator.validate(form.get("institute"));
            description = notEmptyValidator.validate(form.get("description"));
            numberOfTeams = minValidator.validate(form.get("teamCount"));
            minSize = minValidator.validate(form.get("minSize"));
            maxSize = minValidator.validate(form.get("maxSize"));
        } catch (ValidationException e) {
            flash("error", ctx().messages().at("error.wrongInput"));
            return redirect(controllers.routes.AdminPageController.projectEditPage(project.getId()));
        }

        if ((minSize == 0 ^ maxSize == 0) || (maxSize < minSize)) {
            flash("error", ctx().messages().at("error.wrongInput"));
            return redirect(controllers.routes.AdminPageController.projectEditPage(project.getId()));
        }
        ArrayList<Adviser> advisers = new ArrayList<>();
        String[] adviserIds = MultiselectList.getValueArray(form, "adviser-multiselect");
        for (String adviserIdString : adviserIds) {
            int adviserId;
            try {
                adviserId = Integer.parseInt(adviserIdString);
            } catch (NumberFormatException e) {
                flash("error", ctx().messages().at(INTERNAL_ERROR));
                return redirect(controllers.routes.AdminPageController.projectEditPage(project.getId()));
            }
            advisers.add(ElipseModel.getById(Adviser.class, adviserId));
        }
        if (minSize > maxSize) {
            flash("error", ctx().messages().at("index.registration.error.minMax"));
            return redirect(controllers.routes.AdminPageController.projectEditPage(project.getId()));
        }

        // und dem projekt hinzugefügt
        project.doTransaction(() -> {
            project.setAdvisers(advisers);
            project.setInstitute(institute);
            project.setMaxTeamSize(maxSize);
            project.setMinTeamSize(minSize);
            project.setName(projName);
            project.setNumberOfTeams(numberOfTeams);
            project.setProjectInfo(description);
            project.setProjectURL(url);
        });

        return redirect(controllers.routes.AdminPageController.projectPage());
    }
}
