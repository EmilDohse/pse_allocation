// --------------------------------------------------------
// Code generated by Papyrus Java
// --------------------------------------------------------

package data;

import java.util.ArrayList;
import java.util.List;

import javax.persistence.CascadeType;
import javax.persistence.Entity;
import javax.persistence.JoinTable;
import javax.persistence.ManyToMany;
import javax.persistence.ManyToOne;
import javax.persistence.OneToOne;

import exception.DataException;

/************************************************************/
/**
 * Diese Klasse stellt einen Studierenden dar, der am PSE teilnimmt.
 **/
@Entity
public class Student extends User {

    /**
     * Die Matrikelnummer des Studierenden.
     */
    private int               matriculationNumber;
    /**
     * Die SPO des Studierenden
     */
    @ManyToOne(cascade = CascadeType.PERSIST)
    private SPO               spo;
    /**
     * Die bestandenen Teilleistungen.
     */
    @ManyToMany(cascade = CascadeType.PERSIST)
    @JoinTable(name = "STUDENT_ACHIEVEMENT_COMPLETED")
    private List<Achievement> completedAchievements;
    /**
     * Wahr, wenn sich der Studierende bereits im Campus Management System für
     * das PSE angemeldet hat. Falsch, sonst.
     */
    private boolean           registeredPSE;
    /**
     * Wahr, wenn sich der Studierende bereits im Campus Management System für
     * das TSE angemeldet hat. Falsch, sonst.
     */
    private boolean           registeredTSE;
    /**
     * Die PSE-Note des Studierenden.
     */
    @OneToOne(cascade = CascadeType.ALL)
    private Grade             gradePSE;
    /**
     * Die TSE-Note des Studierenden.
     */
    @OneToOne(cascade = CascadeType.ALL)
    private Grade             gradeTSE;
    /**
     * Die noch ausstehenden Teilleistungen des Studierenden.
     */
    @ManyToMany(cascade = CascadeType.PERSIST)
    @JoinTable(name = "STUDENT_ACHIEVEMENT_ORAL")
    private List<Achievement> oralTestAchievements;
    /**
     * Das Fachsemester, in dem sich der Studierende zum Zeitpunkt des letzten
     * Registrierens befindet.
     */
    private int               semester;
    /**
     * Wahrheitswert, ob die E-Mail-Adresse verifiziert wurde.
     */
    private boolean           emailVerified;

    private static final int  MINIMAL_SEMESTER = 1; // TODO Genauer Wert?

    public Student() throws DataException {
        this("default_username", "1234", "anonymous@kit.edu", "Max",
                "Musterman", 0, new SPO(), new ArrayList<>(), new ArrayList<>(),
                0);
    }

    public Student(String username, String password, String emailAddress,
            String firstName, String lastName, int matriculationNumber, SPO spo,
            List<Achievement> completedAchievements,
            List<Achievement> oralTestAchievements, int semester)
            throws DataException {
        super(username, password, emailAddress, firstName, lastName);
        setMatriculationNumber(matriculationNumber);
        setSPO(spo);
        setCompletedAchievements(completedAchievements);
        setOralTestAchievements(oralTestAchievements);
        setSemester(semester);
    }

    /**
     * Getter für die Matrikelnummer.
     * 
     * @return Die Matrikelnummer.
     */
    public int getMatriculationNumber() {
        return matriculationNumber;
    }

    /**
     * Getter für die SPO des Studierenden.
     * 
     * @return Die SPO des Studierenden.
     */
    public SPO getSPO() {
        return spo;
    }

    /**
     * Getter für die abgeschlossenen Teilleistungen des Studierenden.
     * 
     * @return Die abgeschlossenen Teilleistungen des Studierenden.
     */
    public List<Achievement> getCompletedAchievements() {
        return completedAchievements;
    }

    /**
     * Getter für die Variable, ob der Studierende im Campus Management System
     * für das PSE angemeldet ist.
     * 
     * @return Wahr, wenn er angemeldet ist, falsch sonst.
     */
    public boolean isRegisteredPSE() {
        return registeredPSE;
    }

    /**
     * Getter für die Variable, ob der Studierende im Campus Management System
     * für das TSE angemeldet ist.
     * 
     * @return Wahr, wenn er angemeldet ist, falsch sonst.
     */
    public boolean isRegisteredTSE() {
        return registeredTSE;
    }

    /**
     * Getter für die PSE-Note des Studierenden.
     * 
     * @return Die Note des Studierenden für das PSE.
     */
    public Grade getGradePSE() {
        return gradePSE;
    }

    /**
     * Getter für die TSE-Note des Studierenden.
     * 
     * @return Die Note des Studierenden für das TSE.
     */
    public Grade getGradeTSE() {
        return gradeTSE;
    }

    /**
     * Getter für die noch ausstehenden Teilleistungen des Studierenden.
     * 
     * @return Die noch ausstehenden Teilleistungen des Studierenden.
     */
    public List<Achievement> getOralTestAchievements() {
        return oralTestAchievements;
    }

    /**
     * Getter für das Fachsemester des Studierenden.
     * 
     * @return Das aktuelle Fachsemester des Studierenden.
     */
    public int getSemester() {
        return semester;
    }

    /**
     * Setter für die Matrikelnummer.
     * 
     * @param matriculationNumber
     *            Die Matrikelnummer des Studierenden.
     * @throws DataException
     *             Wird vom Controller behandelt.
     */
    public void setMatriculationNumber(int matriculationNumber)
            throws DataException {
        if (matriculationNumber < 0) {
            throw new DataException("student.invalidMatNr");
        }
        this.matriculationNumber = matriculationNumber;
    }

    /**
     * Setter für die SPO des Studierenden.
     * 
     * @param spo
     *            Die SPO des Studierenden.
     * @throws DataException
     *             Wird vom Controller behandelt.
     */
    public void setSPO(SPO spo) throws DataException {
        if (spo == null) {
            throw new DataException(IS_NULL_ERROR);
        }
        this.spo = spo;
    }

    /**
     * Setter für die abgeschlossenen Teilleistungen des Studierenden.
     * 
     * @param completedAchievements
     *            Die vom Studierenden abgeschlossenen Teilleistungen.
     * @throws DataException
     *             Wird vom Controller behandelt.
     */
    public void setCompletedAchievements(
            List<Achievement> completedAchievements) throws DataException {
        if (completedAchievements == null) {
            throw new DataException(IS_NULL_ERROR);
        }
        // TODO auf leere Liste prüfen?
        this.completedAchievements = completedAchievements;
    }

    /**
     * Setter für die Variable, ob der Studierende im campus management system
     * für das PSE angemeldet ist.
     * 
     * @param registeredPSE
     *            Wahr, wenn der Studierende im CMS angemeldet ist, sonst false
     */
    public void setRegisteredPSE(boolean registeredPSE) {
        this.registeredPSE = registeredPSE;
    }

    /**
     * Setter für die Variable, ob der Studierende im campus management system
     * für das TSE angemeldet ist.
     * 
     * @param registeredTSE
     *            Wahr, wenn der Studierende im CMS angemeldet ist, sonst false
     */
    public void setRegisteredTSE(boolean registeredTSE) {
        this.registeredTSE = registeredTSE;
    }

    /**
     * Setter für die PSE-Note des Studierenden.
     * 
     * @param Die
     *            Note des Studierenden fürs PSE.
     * @throws DataException
     *             Wird vom Controller behandelt.
     */
    public void setGradePSE(Grade gradePSE) throws DataException {
        if (gradePSE == null) {
            throw new DataException(IS_NULL_ERROR);
        }
        this.gradePSE = gradePSE;
    }

    /**
     * Setter für die TSE-Note des Studierenden.
     * 
     * @param gradeTSE
     *            Die Note des Studierenden fürs TSE.
     * @throws DataException
     *             Wird vom Controller behandelt.
     */
    public void setGradeTSE(Grade gradeTSE) throws DataException {
        if (gradeTSE == null) {
            throw new DataException(IS_NULL_ERROR);
        }
        this.gradeTSE = gradeTSE;
    }

    /**
     * Setter für die noch ausstehenden Teilleistungen des Studierenden.
     * 
     * @param oralTestAchievement
     *            Die noch aussteheneden Teilleistungen des Studierenden.
     * @throws DataException
     *             Wird vom Controller behandelt.
     */
    public void setOralTestAchievements(List<Achievement> oralTestAchievement)
            throws DataException {
        if (oralTestAchievement == null) {
            throw new DataException(IS_NULL_ERROR);
        }
        this.oralTestAchievements = oralTestAchievement;
    }

    /**
     * Setter für das Fachsemester des Studierenden bei der letzten
     * Registrierung.
     * 
     * @param semester
     *            Das Fachsemester des Studierenden.
     * @throws DataException
     *             Wird vom Controller behandelt.
     */
    public void setSemester(int semester) throws DataException {
        if (semester < MINIMAL_SEMESTER) {
            throw new DataException("student.invalidSemester");
        }
        this.semester = semester;
    }

    /**
     * Diese Methode gibt einen spezifischen Studierenden zurück, der durch
     * seine Matrikelnummer identifiziert wird.
     * 
     * @param matriculationNumber
     *            Die Matrikelnummer des Studierenden.
     * @return Der Studierende. Null, falls kein Student diese Matrikelnummer
     *         hat.
     */
    public static Student getStudent(int matriculationNumber) {
        return getStudents().stream()
                .filter(student -> student
                        .getMatriculationNumber() == matriculationNumber)
                .findFirst().orElse(null);
    }

    /**
     * Diese Methode gibt alle Studierenden zurück.
     * 
     * @return Alle Studierende.
     */
    public static List<Student> getStudents() {
        return ElipseModel.getAll(Student.class);
    }

    public String toStringForNotification() {
        String toReturn = this.getFirstName() + " " + this.getLastName() + ", "
                + this.getSemester();
        return toReturn;
    }

    // /**
    // * Diese Methode gibt die Bewertung des Studiereden zu einem bestimmten
    // * Projekt zurück.
    // *
    // * @param project
    // * Das Projekt.
    // * @return Die Bewertung des Studierenden für das bestimmte Projekt.
    // */
    // public int getRating(Project project) {
    // return project.getRating(this);
    // }

    // /**
    // * Diese Methode gibt das Projekt zurück, dem der Studierende zugeteilt
    // ist.
    // *
    // * @return Das Projekt des Studierenden.
    // */
    // public Project getCurrentProject() {
    // Allocation a =
    // GeneralData.getInstance().getCurrentSemester().getFinalAllocation();
    // if (a == null) {
    // // TODO throws
    // }
    //
    // Team t = a.getTeam(this);
    // if (t == null) {
    // return null;
    // }
    //
    // return t.getProject();
    // }

    // /**
    // * Diese Methode gibt das Team, in dem der Studierende sich befindet,
    // * zurück.
    // *
    // * @return Das Team des Studierenden.
    // */
    // public Team getCurrentTeam() {
    // Allocation a =
    // GeneralData.getInstance().getCurrentSemester().getFinalAllocation();
    // if (a == null) {
    // // TODO throws
    // }
    //
    // return a.getTeam(this);
    // }

    // TODO kann das alles weg?
    /**
     * Diese Methode gibt zurück, ob die E-Mail-Adresse verifiziert wurde.
     * 
     * @return wahr, wenn die E-Mail-Adresse verifiziert wurde, falsch sonst.
     */
    public boolean isEmailVerified() {
        return emailVerified;
    }

    /**
     * Diese Methode setzt per Boolean, ob die E-Mail-Adresse verifiziert wurde
     * oder nicht.
     * 
     * @param isEmailVerified
     *            wahr, wenn die E-Mail-Adresse verifiziert wurde, falsch sonst.
     */
    public void setIsEmailVerified(boolean isEmailVerified) {
        this.emailVerified = isEmailVerified;
    }

    // /**
    // * Gibt die Lerngruppe zurück, in der sich der Student aktuell befindet.
    // *
    // * @return Lerngruppe, in der sich der Student aktuell befindet.
    // */
    // public LearningGroup getCurrentLearningGroup() {
    // return getLearningGroup(GeneralData.getInstance().getCurrentSemester());
    // }

    // /**
    // * Gibt die Lerngruppe zurück, in der der Student im übergebenen Semester
    // * war
    // *
    // * @param semester
    // * Semester, in dem gesucht wird
    // * @return Lerngruppe
    // */
    // public LearningGroup getLearningGroup(Semester semester) {
    // List<LearningGroup> list = semester.getLearningGroups();
    // for (LearningGroup l : list) {
    // if (l.getMembers().contains(this)) {
    // return l;
    // }
    // }
    // // TODO throws
    // return null;
    // }
    // TODO kann das alles weg?

    /**
     * Returns true if a student is registered in more than one semester
     *
     * @return registered in more than one semester
     */
    public boolean registeredMoreThanOnce() {
        int timesRegistered = 0;

        for (Semester s : Semester.getSemesters()) {
            if (s.getStudents().contains(this)) {
                timesRegistered++;
            }
        }

        if (timesRegistered >= 2) {
            return true;
        } else {
            return false;
        }
    }
}
